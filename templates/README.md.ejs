# moltbot-env

Environment-specific deployment configurations for [moltbot-app](<%= appRepo.replace('git@github.com:', 'https://github.com/').replace(/\.git$/, '') %>).

## Architecture

GitOps overlay pattern — each overlay stores its complete `vars` block plus environment-specific config overrides, merged with the app repo's base `wrangler.jsonc` at deploy time.

```
overlays/<env>/
├── Makefile → ../../Makefile      # Symlink to shared targets
├── wrangler.jsonc                 # Environment config overrides
├── version.txt                    # Pinned app commit SHA
└── secrets.json                   # SOPS-encrypted secrets (AGE)
```

## Commands

All commands run from an overlay directory (e.g., `cd overlays/<env-name>`):

```bash
make deploy                              # Full deploy pipeline (code + secrets)
make secret KEY=ANTHROPIC_API_KEY        # Set a Wrangler secret interactively
make wrangler CMD='secret list'          # Run arbitrary wrangler command
make wrangler CMD='tail'                 # Stream live logs
make merged-config APP_DIR=/path/to/app  # Inspect final merged config
make sync-access                         # Sync CF Access apps (requires CF_ACCESS_API_TOKEN)
make edit-secrets                        # Edit secrets via SOPS (requires SOPS_AGE_KEY)
make push-secrets                        # Decrypt and bulk-push secrets to Cloudflare
```

## Creating a New Environment

```bash
CF_ACCESS_API_TOKEN="<token>" bash scripts/create-env.sh <env-name>
```

## Secret Management

**Prerequisites:** `SOPS_AGE_KEY` env var must be set.

1. **Add/edit secrets**: `cd overlays/<env> && make edit-secrets` → commit the encrypted `secrets.json`
2. **Push secrets only**: `cd overlays/<env> && make push-secrets`
3. **Full deploy** (code + secrets): `cd overlays/<env> && make deploy`

## External Dependencies

Requires `node`, `jq`, `git`, `sops`, `age` (`age-keygen`), and `npx wrangler` available on PATH.

---

*Scaffolded with [@aehrt55/create-moltbot-env](https://www.npmjs.com/package/@aehrt55/create-moltbot-env)*
