#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"
ENV_NAME="${1:?Usage: deploy.sh <environment>}"
OVERLAY_DIR="$ROOT_DIR/overlays/$ENV_NAME"

if [[ ! -d "$OVERLAY_DIR" ]]; then
  echo "Error: overlay '$ENV_NAME' not found at $OVERLAY_DIR" >&2; exit 1
fi

VERSION=$(tr -d '[:space:]' < "$OVERLAY_DIR/version.txt")
APP_REPO="<%= appRepo %>"
WORK_DIR="/tmp/deploy-moltbot-$$"
trap 'rm -rf "$WORK_DIR"' EXIT

echo "▶ Deploying moltbot @ ${VERSION} (${ENV_NAME})"

# 1. Clone app repo at pinned version
git clone "$APP_REPO" "$WORK_DIR"
cd "$WORK_DIR"
git checkout "$VERSION"

# 2. Install dependencies
npm ci

# 3. Merge configs: base (app repo) + overlay (env repo)
echo "▶ Merging wrangler config..."
STRIP="node $SCRIPT_DIR/jsonc-strip.js"
merged=$(mktemp)
jq -s '.[0] * .[1]' <($STRIP "$WORK_DIR/wrangler.jsonc") <($STRIP "$OVERLAY_DIR/wrangler.jsonc") > "$merged"
mv "$merged" "$WORK_DIR/wrangler.jsonc"

# 4. Deploy
npx wrangler deploy

# 5. Push secrets (if secrets.json exists)
if [[ -f "$OVERLAY_DIR/secrets.json" ]]; then
  echo "▶ Deploying secrets..."
  [[ -n "${SOPS_AGE_KEY:-}" ]] || { echo "Error: SOPS_AGE_KEY not set" >&2; exit 1; }
  secrets=$(mktemp)
  sops decrypt "$OVERLAY_DIR/secrets.json" > "$secrets"
  npx wrangler secret bulk "$secrets"
  rm -f "$secrets"
fi

echo "✅ Deploy complete: moltbot @ ${VERSION} (${ENV_NAME})"
