# Migration: 0.1.1 → 0.2.0

This migration introduces a runtime config file (`.moltbot-env.json`) that scripts read via `jq` at runtime, replacing the previous approach of baking values into scripts at scaffold time. It also adds CI/CD deployment via GitHub Actions.

## Prerequisites

You'll need the following values from your current baked-in scripts:
- `cfAccountId` — from `create-env.sh` or `delete-env.sh`
- `workersSubdomain` — from `sync-access.sh` (the part before `.workers.dev`)
- `cfAccessTeamDomain` — from `create-env.sh`
- `accessPolicyEmail` — from `create-env.sh` (in the Access policy)
- `appRepo` — from `deploy.sh` or `Makefile` (convert git URL to `owner/repo` slug)
- `managerAgeKey` — from `create-env.sh` or `.sops.yaml` comments

## Steps

### 1. Create `.moltbot-env.json`

Create `.moltbot-env.json` in the repo root with your values:

```json
{
  "appRepo": "<owner/repo>",
  "envRepo": "<owner/env-repo>",
  "cfAccountId": "<your-cf-account-id>",
  "workersSubdomain": "<your-workers-subdomain>",
  "cfAccessTeamDomain": "<subdomain>.cloudflareaccess.com",
  "accessPolicyEmail": "<your-email>",
  "managerAgeKey": "<your-manager-age-public-key>",
  "credentials": {
    "sopsAgeKey": {
      "source": "keychain",
      "keychainAccount": "sops-age",
      "keychainService": "sops-age-key"
    },
    "cfAccessApiToken": {
      "source": "keychain",
      "keychainAccount": "cf-access-api-token",
      "keychainService": "cf-access-api-token"
    }
  },
  "meta": {
    "version": "0.2.0",
    "createdAt": "<original-created-date>",
    "lastUpgrade": "<today's-date>"
  }
}
```

### 2. Delete `.moltbot-env-meta.json`

```bash
rm .moltbot-env-meta.json
```

### 3. Update all scripts

Replace scripts with new versions that read from `.moltbot-env.json` at runtime:
- `scripts/deploy.sh` — reads `appRepo` from config, supports `APP_REPO` env var override, checks `CLOUDFLARE_API_TOKEN`
- `scripts/create-env.sh` — reads all config values from `.moltbot-env.json`, generates env AGE key pair, auto-loads credentials
- `scripts/delete-env.sh` — reads `cfAccountId` from config, auto-loads credentials, deletes container apps
- `scripts/sync-access.sh` — reads `cfAccountId` and `workersSubdomain` from config, auto-loads credentials

Run `npx @aehrt55/create-moltbot-env diff --json` to get the latest file contents, or copy from a freshly scaffolded repo.

### 4. Update Makefile

Remove the `APP_REPO` variable line. The new Makefile is fully static.

### 5. Update `.sops.yaml`

Replace the manager key reference in comments with a generic placeholder:
```
#      <manager-age-key> (see .moltbot-env.json)
```

### 6. Add `.github/workflows/deploy.yml`

Copy the deploy workflow from a freshly scaffolded repo. Key features:
- Auto-detects changed overlays on push to `main`
- Matrix deploy with per-environment GitHub Environments
- Reads `appRepo` from `.moltbot-env.json` for HTTPS clone URL
- Installs sops/age with SHA256 checksum verification
- Supports `workflow_dispatch` for manual deploys

### 7. Add `scripts/setup-env-age-key.sh`

Copy from a freshly scaffolded repo. This script:
- Generates or regenerates AGE key pair for an environment
- Updates `.sops.yaml` atomically
- Re-encrypts secrets.json if it exists
- Reads `managerAgeKey` from `.moltbot-env.json`

### 8. Update `.claude/commands/`

Replace all command files with new static versions:
- `create-env.md` — reads config from `.moltbot-env.json`, uses `<envRepo>` placeholder, adds Phase 2.5 for GitHub Actions setup
- `delete-env.md` — reads config, adds Phase 3 for GitHub Actions cleanup
- `setup-env-age-key.md` — new command for AGE key management
- `upgrade.md` — references `.moltbot-env.json` instead of `.moltbot-env-meta.json`

### 9. Update CLAUDE.md and README.md

Update to reflect:
- `.moltbot-env.json` in architecture section
- CI/CD deploy flow documentation
- `scripts/setup-env-age-key.sh` in key scripts
- Credential loading from config (instead of hardcoded Keychain instructions)
- Simplified `appRepo` links using slug format

### 10. Verify

1. Check no remaining baked-in values in scripts: `grep -r 'cc38da9\|aehrt55\.cloudflareaccess\|age1ya7' scripts/`
2. Check all scripts read from config: `grep -l 'moltbot-env\.json' scripts/*.sh`
3. Check `.sh` files are executable: `ls -la scripts/*.sh`
4. Verify `.moltbot-env.json` has correct `meta.version`: `jq '.meta.version' .moltbot-env.json`
